## 记一个神奇的BUG

今天遇到一个神奇的BUG，
解决方式虽然非常简单。
但它暴露出来一个问题，
即，我已经被弱类型语言给惯坏了。

---

- [记一个神奇的BUG](#记一个神奇的bug)
- [场景还原](#场景还原)
  - [问题分析](#问题分析)
  - [问题解决](#问题解决)

## 场景还原

我要做的功能很简单，
就是把`Free Surfer`软件的皮层数据放在前端可视化一下，
不免会用到`WebGL`，
正确的效果应该是这样的

![Brain-1](Brain-1.png)

但我在部署之后，却得到了这么个玩意

![Brain-2](Brain-2.png)

很明显，
错误出现在渲染器在找顶点位置时遇到了错误，
而到程序员，也就是我，的层面，
就形成了一个十分诡异的BUG。

### 问题分析

说它诡异是因为在简单的`BUNNY`免测试用例中，
这个BUG是不会出现的，
只是在我的数据中才出现，
就是很让人头疼。

头疼在哪呢？
我们来看两组数字，

- `BUNNY`免测试用例中顶点数量为`1,839`，面元数量为`3,674`；
- 而我的数据中顶点数量为`327,680`，面元数量为`163,842`。

由于数据规模过大，
这就导致直接检查哪里出了问题几乎是不可能是事情。

但也并是完全没有头绪，
经过排查发现，
当顶点序数超过`65536`时，
渲染混乱的现象就会发生。

### 问题解决

`65536`是个神奇的数字，

> 它代表无符号短整形的上限。

果然，在[WebGL的API](https://github.com/regl-project/regl/blob/master/API.md "WebGL的API")中，
我找到了如下内容

| Data type | Description       | Extension?             |
| --------- | ----------------- | ---------------------- |
| 'uint8'   | gl.UNSIGNED_BYTE  |
| 'uint16'  | gl.UNSIGNED_SHORT |
| 'uint32'  | gl.UNSIGNED_INT   | OES_element_index_uint |

这说明在渲染过程中，
程序默认使用短整形进行顶点选取，
而由于我的数据顶点数量超过了它的表示范围，
程序无法调用到超过`65536`序号的顶点，
随即产生渲染BUG。

在添加`UINT32`运行后，
问题即告解决。

解决方式虽然非常简单。
但它暴露出来一个问题，

> 我已经被弱类型语言给惯坏了，
> 开始丧失了对数据类型的敏感性。

希望之后以此为戒。

本工程代码可见[我的代码仓库](https://observablehq.com/@listenzcc/free-surfer-cortex "我的代码仓库")。