# 任意三角形的SDF组合与阴影投射

将之前的内容组合起来就得到了这样一个“利用SDF进行实时投影计算”的样例程序。
在我的ObservableHQ开源笔记本可以找到它，

[SDF and Ray Tracing (Dev. III)](https://observablehq.com/@listenzcc/sdf-and-ray-tracing-dev-iii)

---
[toc]

## 组合过程

为了完整地理解和实现利用SDF（Signed Distance Field）进行实时阴影投射，我们需要整理之前提及的各个步骤。以下是对每一步的扩展解释：

### **1. 计算三角形的SDF**

对于任意三角形，计算一个点到该三角形的最短距离是一个几何问题。在2D或3D空间中，这涉及到判断点与三角形的相对位置，包括点是否位于三角形的边上、内部或外部。对于位于三角形外部的点，最短距离是到最近的顶点或边的距离。对于内部的点，最短距离可以是到三角形边的垂直距离。这一步骤通常需要一些向量计算和几何知识。

### **2. 多个SDF的叠加**

在场景中，可能有多个三角形对象，因此需要将它们的SDF组合起来。这可以通过对每个像素点计算其到所有三角形的SDF，然后取这些SDF中的最小值来实现。这样，得到的SDF代表了点到最近三角形表面的最短距离。这个步骤主要涉及到一些基本的迭代和比较操作。

### **3. 基于SDF的投影计算**

在有了场景中所有物体的SDF之后，可以利用这个信息来计算阴影。具体来说，对于场景中的每个像素，沿着光源到该像素的路径进行采样，使用SDF作为步长进行迭代。如果在到达像素点之前，路径上的某一点的SDF值小于或等于零，则表明该点在三角形内部或边缘，因此该像素应该处于阴影之中。这个过程涉及到光线追踪和光线-物体交互的基本概念。

### **4. WebGL实现和帧迭代**

为了实现实时渲染，所有这些计算都需要在WebGL中进行。WebGL提供了GPU加速的图形计算能力，这对于处理复杂的3D场景和大量的像素非常必要。在实践中，这通常意味着编写GLSL（OpenGL Shading Language）着色器程序来执行上述计算。帧迭代是指在每个渲染帧中重复这些计算，以实现动态的场景和光影效果。

结合以上步骤，我们可以构建一个实时阴影投射系统。这个系统会首先计算场景中每个三角形的SDF，并将这些SDF组合成全局的场景SDF。然后，在渲染每一帧时，系统会根据这个场景SDF来计算每个像素是否应该被投射阴影。通过在WebGL中实现这一系列计算，可以创建出逼真的光影效果，增强3D场景的视觉深度和现实感。

## 组合效果

这些图像和动图为我们提供了SDF在实时阴影投射中的应用的直观展示。在这些示例中，SDF被用来定义场景中每个点到最近物体表面的距离，并用于计算阴影。让我们基于这些图像和动图来扩展和解释之前的概念。

### **SDF场的可视化和阴影投射**

在第一个和第二个静态图中，我们看到了用白色等势线表示的SDF场。这些等势线显示了具有相同距离值的点的轮廓，类似于地图上的等高线。这些线越接近三角形的边缘，它们之间的间距就越小，反映了距离场在边缘附近变化更加急剧。SDF场的这种可视化有助于理解场景中的距离关系，并为阴影投射提供了必要的信息。

### **阴影投射**

图像中的红点代表光源。深蓝色区域表示由三角形投射的阴影。在SDF的上下文中，阴影是通过沿从光源出发的射线进行采样并检测这些射线是否与任何物体相交来计算的。如果在达到某一点之前，射线上的SDF值变为零或负数，则表明光线被物体遮挡，因此该点位于阴影中。

![Untitled](%E4%BB%BB%E6%84%8F%E4%B8%89%E8%A7%92%E5%BD%A2%E7%9A%84SDF%E7%BB%84%E5%90%88%E4%B8%8E%E9%98%B4%E5%BD%B1%E6%8A%95%E5%B0%84%207b1b285ddbd04824a6c969d66aa1d72e/Untitled.png)

![Untitled](%E4%BB%BB%E6%84%8F%E4%B8%89%E8%A7%92%E5%BD%A2%E7%9A%84SDF%E7%BB%84%E5%90%88%E4%B8%8E%E9%98%B4%E5%BD%B1%E6%8A%95%E5%B0%84%207b1b285ddbd04824a6c969d66aa1d72e/Untitled%201.png)

### **动态SDF场变化**

在动图中，展示了随着三角形的动态加载和消失，SDF场是如何连续变化的。当新的三角形加入场景时，等势线会根据新形状的几何特征进行调整。类似地，当一个三角形从场景中消失时，等势线会重新配置以反映新的最近距离关系。这种动态变化显示了SDF的适应性和实时计算的重要性，这对于动态场景和交互式应用尤为关键。

下面的动图呈现的是SDF场和阴影投射的动态计算过程，我在整个过程中动态地加载三角形，当旧三角形消失和新三角形加入时，SDF场以连续的形式“逐渐变化”，下图中等势线的运动过程呈现了这一点。

![gif](%E4%BB%BB%E6%84%8F%E4%B8%89%E8%A7%92%E5%BD%A2%E7%9A%84SDF%E7%BB%84%E5%90%88%E4%B8%8E%E9%98%B4%E5%BD%B1%E6%8A%95%E5%B0%84%207b1b285ddbd04824a6c969d66aa1d72e/20240126-191640.gif)

另外，受到文件大小所限，我并没有录制太长时间，但需要说明的是，当三角形不再变化之后，它们的SDF会在有限时间内逐渐收敛到稳定状态。