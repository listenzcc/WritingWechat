# 扩散模型入门（四）

从如前文所述的例子观点来看，随机信号是方差的游戏。在实际场景中，我们很难事先知道协方差矩阵的精确值，事实上我们往往需要用对角矩阵来模拟它。而扩散模型则有希望完成两者之间的跨越。

我们将扩散过程看作是在一系列均值为零的高维空间中不断采样，这些采样的累积效应将信号扩散到标准正态空间中。最终将扩散过程理解成这样一个动态过程，它不断地、蚂蚁搬家式地将先验信号$X_0$的协方差矩阵“替换”为标准正态分布的协方差矩阵。

我想在这里吐个槽，初学数理统计时喜欢算均值，觉得方差是碍事的东西，但越学越反过来，开始觉得**数理统计是研究方差的学问，均值是妨碍我理解它的绊脚石**。

---
- [扩散模型入门（四）](#扩散模型入门四)
  - [扩散过程的递归表示](#扩散过程的递归表示)
  - [从方差的角度理解扩散递归](#从方差的角度理解扩散递归)
  - [通过链式推导实现状态跨越](#通过链式推导实现状态跨越)


## 扩散过程的递归表示

首先，满足多维高斯的随机变量总可以表示成如下形式

$$
X \sim \mathcal{N}(\mu, \Sigma)
\rightarrow
p(x) = \mathcal{N}(x; \mu, \Sigma), x \in R^n
$$

而扩散过程总是从某个状态开始，以近似微分的方式向新的状态“演变”，演变的终点是噪声。这个过程可以表示成条件概率的形式

$$
\begin{cases}
p(x_t | x_{t-1}) = 
\mathcal{N}(x_t; \sqrt{1 - \beta_t} x_{t-1}, \beta_t I)\\
\lim_{t \rightarrow \infty} q(x_t) = \mathcal{N}(x; 0, I) \\
\beta_1 < \beta_2 < ... < \beta_t < \mathcal{C}
\end{cases}
$$

乍看起来，第一个式子所代表的扩散过程是均值和方差都在不断变化的过程，最终回归到噪声。但这样的想法立即产生了矛盾，因为这个过程要求扩散过程遵循某种规律，这种规律需要“巧合地”将原始信号回归到噪声。

**这种规律无疑是违背随机性的，因为你不能既要求随机性，又要求随机性满足数据的特征。**

下面我们将着手拆解这个矛盾，拆解的第一步是将均值去掉。

## 从方差的角度理解扩散递归

细细想来，我们似乎能够从方差的角度重新理解这个过程，而这个过程与均值没有关系，**我们将扩散过程看作是在一系列均值为零的高维空间中不断采样，这些采样的累积效应将信号扩散到标准正态空间中**。

首先，将协方差矩阵简化，将其均值项置零

$$
\Sigma = (X-\mu)^T(X - \mu) \rightarrow
\Sigma = X^T X
$$

接下来，考虑将两个这样的随机变量加权求和

$$
Y = a X_1 + b X_2
$$

其协方差矩阵为

$$
\Sigma_Y = (a X_1 + b X_2) ^T (a X_1 + b X_2) = a^2 \Sigma_1 + b^2 \Sigma_2 + 2ab \cdot \mathcal{Cov}(X_1, X_2)
$$

由于两个随机变量相互独立，因此有

$$
\Sigma_Y = a^2 \Sigma_1 + b^2 \Sigma_2
$$

回到扩散过程，我们将均值项看作是 $X_1$ 的一次采样，而方差项看作是随机变量 $X_2$，则有

$$
\begin{cases}
x_{t-1} \sim X_1\\
a = \sqrt{1 - \beta_t}\\
b = \beta_t
\end{cases}

\rightarrow

\Sigma_{X_t} = (1 - \beta_t) \Sigma_{t-1} + \beta_t I
$$

这样变换的原因是采样虽然会导致随机变量固定下来，但采样之间是随机的，因此对扩散过程来说，它的第一项变化还是可以用随机变量来表示，也就是说，**独立采样多次的高维变量，其取值概率等同于其原始分布**。你看，如果排除到均值的干扰，这个式子看着就顺眼多了。

## 通过链式推导实现状态跨越

接下来，我通过链式推导让它更规范一些

$$
\begin{cases}
\Sigma_{t} = (1 - \beta_t) \Sigma_{t-1} + \beta_t I \\
\Sigma_{t-1} = (1 - \beta_{t-1}) \Sigma_{t-2} + \beta_{t-1} I
\end{cases}
$$

将上式进行代入，则有以下迭代式

$$
\begin{cases}
\Sigma_t  & = a \Sigma_{t-2} + b I \\
\Sigma_{t-2} &: a = (1 - \beta_t)(1 - \beta_{t-1})\\
I &: b = 1 - (1 - \beta_t)(1 - \beta_{t-1})
\end{cases}
$$

定义新变量

$$
\begin{cases}
\bar{\alpha}_t := \Pi_{s=1}^t \alpha_s \\
\alpha_t := 1 - \beta_t
\end{cases}
$$

由$\beta$序列的性质可知，$\alpha$序列是缓慢降低的序列$\alpha: 1 \rightarrow 0$。将其代回迭代式，则有

$$
\Sigma_t = \bar{\alpha}_t \Sigma_0 + (1 - \bar{\alpha}_t) I
$$

易知

$$
p(x_t | x_0) = 
\mathcal{N}(x_t; \sqrt{\bar{\alpha}_t}x_0, (1 - \bar{\alpha}_t) I)
$$

因此，我们可以将扩散过程理解成这样一个动态过程，**它不断地、蚂蚁搬家式地将先验信号$X_0$的协方差矩阵“替换”为标准正态分布的协方差矩阵**。先验信号怎么来的？它是从协方差矩阵未知的高维正态分布采样得来的。就像下面这样

![Untitled](%E6%89%A9%E6%95%A3%E6%A8%A1%E5%9E%8B%E5%85%A5%E9%97%A8%EF%BC%88%E5%9B%9B%EF%BC%89%2007dff0c9daef416685b3c06b65248872/Untitled.png)