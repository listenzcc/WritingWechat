# 一种实用的chatgpt主从框架

该系统框架通过主从架构解决了小型团队在使用ChatGPT类工具时的难题。服务端主机负责用户鉴权、提供界面和消息分发，而从属机通过长连接处理消息，格式化并向互联网服务商发送请求，保障统一身份和数据安全。该异步通信机制支持负载均衡，同时隔离了主机和梯子，提高了系统可维护性，有效解决了团队内部信息共享和安全问题。

---
- [一种实用的chatgpt主从框架](#一种实用的chatgpt主从框架)
  - [要解决的问题](#要解决的问题)
  - [系统结构](#系统结构)
  - [服务端主机](#服务端主机)
  - [从属机](#从属机)


## 要解决的问题

Chatgpt 代表一大类工具，接受用户的输入指令并返回结果。这类工具的性能往往毋庸置疑，但对于小型团体来说，也有一些因素导致其使用困难

- 需要梯子，但固定 IP 服务器不方便架梯子
- 工具的提供方通过私人密钥进行用户识别，不鼓励密钥分享
- 如何保证数据安全和团队内部信息共享和持久化

## 系统结构

为了解决以上问题，本文搭建系统框架如下，涉及的机器分为两种，分别是服务端主机和从属机。

![chatgpt-server.drawio (1).png](%E4%B8%80%E7%A7%8D%E5%AE%9E%E7%94%A8%E7%9A%84chatgpt%E4%B8%BB%E4%BB%8E%E6%A1%86%E6%9E%B6%20a82e55ac59ee4905a87476c0da2fc0a7/chatgpt-server.drawio_(1).png)

## 服务端主机

服务端主机只有一台，负责用户鉴权并提供 HTTP 协议的界面服务。除此之外，主机还维护一个 websocket 服务程序，用于接受从属机的连接。

用户通过该主机提供的界面进行信息输入，主机不处理这些信息，而是直接交给从属机。从属机针对每一条消息进行处理，并在处理完成后返回处理结果，主机得到处理结果后再分发给用户。这些信息也可以作为团队资源进行共享。

另外，整个通信过程是异步的，主机不会因为等待结果而发生阻塞，因此主机可以进行负载均衡。

## 从属机

从属机不止一台，它们通过 websocket 客户端连接的形式与主机连接，这些连接是长连接。

从属机完成连接后即宣告可以处理主机发来的信息。这些信息通常是向需要梯子的互联网工具服务提供商发送的信息，因此要对这些信息做两件事情

1. 将消息进行格式化，避免与服务商提供的 API 产生格式错误；
2. 维护必要的身份信息，防止信息错误返回。

这样做的好处是由统一身份（从属机）向服务商发起请求，服务商始终与从属机对话，防止多用户共同使用引发的种种问题。

另一个好处是避免固定 IP 的主机架梯子可能导致的安全问题。由于梯子是架在另外的机器上，而两台机器通过从属机主动发起的 websocket 客户端连接而产生通信，因此起到了隔离主机的作用。另外，系统维护也只需要临时下线从属机就可以完成，进一步提升了系统可维护性。