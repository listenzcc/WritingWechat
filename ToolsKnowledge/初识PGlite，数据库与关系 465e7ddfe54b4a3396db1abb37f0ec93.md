# 初识PGlite，数据库与关系

数据库设计的核心在于表之间的关系，主要通过外键建立，包括一对一、一对多和多对多关系。利用联合查询、聚合函数、分组和排序等技术，可以高效地执行复杂查询，如通过颜色或标签检索图像并分析其分布。这些关系和查询方法使得关系型数据库在处理和分析复杂数据关系方面极为强大。

[Wall Haven Papers](https://observablehq.com/@listenzcc/wall-haven-papers)

---
[toc]

## 表及其关系

数据库最重要的功能并非增、删、改、查，而是要关注数据背后的关系，数据关系体现在表之间的关系上。比如一个图像数据库，每张图像有唯一的uid，我为它建立三张表

- 表一是信息表（wallpaper），它是一对一的关系，它存储了图像的url位置、图像长宽等信息
- 表二是颜色表（color），它是一对多的关系，它代表图像对应的几个特征颜色
- 表三是标签表（tag），它也是一对多的关系，它代表图像对应的几个特征标签信息

在建立了三张表之后，数据的工作就是通过uid建立特征标签（tag）、特征颜色（color）、图像长宽（size）之间的复杂关系。用户可以通过简单的query语句实现tag、color和size之间的联合查询。

### **深入理解表关系**

表关系是数据库设计的核心，让我们能够有效地组织和查询数据。在PGlite或任何关系型数据库中，表关系通过外键（Foreign Key）建立。外键是一个表中的字段，它引用了另一个表的主键字段，从而在两个表之间建立了链接。这种设计允许我们维护数据的完整性和一致性。

通过利用外键，我们可以实现几种类型的表关系：

- **一对一关系**：在这种关系中，一个表中的记录仅与另一个表中的一个记录相关联。例如，如果我们有一个用户表和一个用户详情表，每个用户只有一个详细信息记录，我们可以通过在用户详情表中设置外键指向用户表的主键来建立一对一关系。
- **一对多关系**：这是最常见的关系类型，其中一个表中的记录可以与另一个表中的多个记录相关联。比如，一个图像可以有多种颜色和多个标签，正如上述例子所示。
- **多对多关系**：在这种关系中，一个表中的记录可以与另一个表中的多个记录相关联，反之亦然。通常，这通过一个中间表来实现，中间表包含了两个表的外键。

## PGlite数据库小例

- 检索特征颜色包含#660000的全部图像

![Untitled](%E5%88%9D%E8%AF%86PGlite%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E5%85%B3%E7%B3%BB%20465e7ddfe54b4a3396db1abb37f0ec93/Untitled.png)

```jsx
SELECT * FROM color
INNER JOIN wallpaper ON color.uid = wallpaper.uid
WHERE color.hex='#660000'
```

- 检索标签为Art & Design的全部图像，并统计它们它们的颜色分布

![Untitled](%E5%88%9D%E8%AF%86PGlite%EF%BC%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%8E%E5%85%B3%E7%B3%BB%20465e7ddfe54b4a3396db1abb37f0ec93/Untitled%201.png)

```jsx
SELECT hex, title, level, COUNT(hex) FROM color
INNER JOIN tag ON tag.uid = color.uid
WHERE title='Art & Design'
GROUP BY color.hex, tag.title, tag.level
ORDER BY COUNT(hex) DESC
```

了解了表之间的关系后，我们可以执行更复杂的查询，比如在上例中的联合查询、分组、排序等，以获取我们需要的信息。例如：

- **联合查询**：上述示例中使用的**`INNER JOIN`**语句就是一个典型的联合查询，它允许我们将不同表中的相关记录组合成一条记录。
- **聚合函数**：如`COUNT()`, `SUM()`, `AVG()`等，它们用于对一组值执行计算并返回单个值。在第二个查询示例中，`COUNT(hex)`就是用来统计具有相同颜色的图像数量。
- **分组和排序**：`GROUP BY`和`ORDER BY`子句允许我们根据某一列或多列的值对结果集进行分组和排序。在检索“Art & Design”标签的图像并统计它们的颜色分布的查询中，我们首先按颜色分组，然后按颜色出现的次数降序排序，这样最常见的颜色就会排在前面。

通过理解和利用这些关系和查询技巧，你可以高效地从数据库中检索需要的信息，并能够对数据进行深入的分析和处理。关系型数据库的强大功能使其成为处理复杂数据关系的理想选择。
